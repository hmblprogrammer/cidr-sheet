<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Network Manager</title>
  <!-- Tabulator CSS -->
  <link href="https://unpkg.com/tabulator-tables@5.4.3/dist/css/tabulator.min.css" rel="stylesheet" />
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #controls { margin-bottom: 10px; }
    #controls button { margin-right: 5px; }
  </style>
</head>
<body>
  <h1>Network Manager</h1>
  <div id="controls">
    <button id="add-network">Add Network</button>
    <button id="download-json">Export JSON</button>
    <button id="load-json">Load JSON</button>
    <button id="show-columns">Show All Columns</button>
  </div>
  <div id="network-table"></div>
  <input type="file" id="file-input" accept=".json" style="display:none" />

  <!-- Tabulator JS -->
  <script src="https://unpkg.com/tabulator-tables@5.4.3/dist/js/tabulator.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Helper functions for CIDR calculations
      function numToIp(num) {
        return [(num >>> 24) & 0xFF, (num >>> 16) & 0xFF, (num >>> 8) & 0xFF, num & 0xFF].join('.');
      }

      function parseCidr(cidr) {
        const parts = cidr.split('/');
        const ip = parts[0];
        const mask = parseInt(parts[1], 10);
        const ipParts = ip.split('.').map(x => parseInt(x, 10));
        const ipNum = (((ipParts[0] << 24) >>> 0) + (ipParts[1] << 16) + (ipParts[2] << 8) + ipParts[3]) >>> 0;
        const hostBits = 32 - mask;
        const maskBits = mask === 0 ? 0 : ((~0 << hostBits) >>> 0);
        const network = (ipNum & maskBits) >>> 0;
        const broadcast = (network | ((1 << hostBits) - 1)) >>> 0;
        return { first: numToIp(network), last: numToIp(broadcast) };
      }

      function formatIpRange(cidr) {
        if (!cidr) return '';
        try {
          const { first, last } = parseCidr(cidr);
          return `${first} - ${last}`;
        } catch (e) {
          return '';
        }
      }

      function countIps(cidr) {
        if (!cidr) return '';
        const mask = parseInt(cidr.split('/')[1], 10);
        return Math.pow(2, 32 - mask);
      }

      // Initial data
      const initialData = [
        {
          name: "Office LAN",
          region: "Building A",
          location: "Floor 1",
          cidr: "10.0.1.0/24",
          vlan: 10,
          status: "In use",
          description: "Office network",
          tags: "core,prod",
          ip_range: formatIpRange("10.0.1.0/24"),
          num_ips: countIps("10.0.1.0/24")
        },
        {
          name: "AWS Default VPC",
          region: "AWS us-east-1",
          location: "us-east-1a",
          cidr: "172.31.0.0/16",
          vlan: 0,
          status: "In use",
          description: "AWS default VPC",
          tags: "aws,default",
          ip_range: formatIpRange("172.31.0.0/16"),
          num_ips: countIps("172.31.0.0/16")
        }
      ];

      // Create Tabulator instance
      const table = new Tabulator("#network-table", {
        data: initialData,
        layout: "fitColumns",
        reactiveData: true,
        addRowPos: "top",
        height: "600px",
        columns: [
          { title: "Name", field: "name", editor: "input", headerFilter: "input", headerMenu: [{ label: "Hide Column", action: (e, column) => column.hide() }] },
          { title: "Region/Site", field: "region", editor: "input", headerFilter: "input", headerMenu: [{ label: "Hide Column", action: (e, column) => column.hide() }] },
          { title: "Location", field: "location", editor: "input", headerFilter: "input", headerMenu: [{ label: "Hide Column", action: (e, column) => column.hide() }] },
          { title: "CIDR Range", field: "cidr", editor: "input", headerFilter: "input", validator: ["required", { type: "regex", regex: /^(?:\d{1,3}\.){3}\d{1,3}\/(?:[0-9]|[12][0-9]|3[0-2])$/ }], headerMenu: [{ label: "Hide Column", action: (e, column) => column.hide() }] },
          { title: "VLAN ID", field: "vlan", editor: "number", headerFilter: "number", headerMenu: [{ label: "Hide Column", action: (e, column) => column.hide() }] },
          { title: "Status", field: "status", editor: "list", editorParams: { values: { "In use":"In use", "Deprecated":"Deprecated", "Legacy":"Legacy", "Decommissioned":"Decommissioned", "Proposed":"Proposed", "Future State":"Future State" } }, headerFilter: "select", headerFilterParams: { values: { "":"(all)", "In use":"In use", "Deprecated":"Deprecated", "Legacy":"Legacy", "Decommissioned":"Decommissioned", "Proposed":"Proposed", "Future State":"Future State" } }, headerMenu: [{ label: "Hide Column", action: (e, column) => column.hide() }] },
          { title: "Description", field: "description", editor: "textarea", headerFilter: "input", headerMenu: [{ label: "Hide Column", action: (e, column) => column.hide() }] },
          { title: "Tags", field: "tags", formatter: "list", formatterParams: { delimiter: "," }, editor: "input", headerFilter: "input", headerMenu: [{ label: "Hide Column", action: (e, column) => column.hide() }] },
          { title: "IP Range", field: "ip_range", hozAlign: "center", headerMenu: [{ label: "Hide Column", action: (e, column) => column.hide() }] },
          { title: "# IPs", field: "num_ips", hozAlign: "center", sorter: "number", headerMenu: [{ label: "Hide Column", action: (e, column) => column.hide() }] },
          { title: "Actions", field: "actions", formatter: "buttonCross", width: 50, hozAlign: "center", headerSort: false, headerMenu: [{ label: "Hide Column", action: (e, column) => column.hide() }], cellClick: (e, cell) => cell.getRow().delete() }
        ]
      });

      // Update computed columns on edit
      table.on("cellEdited", (cell) => {
        if (cell.getField() === "cidr") {
          const newCidr = cell.getValue();
          cell.getRow().update({
            ip_range: formatIpRange(newCidr),
            num_ips: countIps(newCidr)
          });
        }
      });

      // Control bindings
      document.getElementById("add-network").addEventListener("click", () => {
        table.addRow({ name: "", region: "", location: "", cidr: "", vlan: null, status: "Proposed", description: "", tags: "", ip_range: "", num_ips: "" });
      });

      document.getElementById("download-json").addEventListener("click", () => {
        const data = table.getData();
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.download = "networks.json";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
      });

      document.getElementById("load-json").addEventListener("click", () => document.getElementById("file-input").click());
      document.getElementById("file-input").addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
          try {
            const data = JSON.parse(ev.target.result);
            table.replaceData(data);
          } catch (err) {
            alert("Invalid JSON file");
          }
        };
        reader.readAsText(file);
      });

      document.getElementById("show-columns").addEventListener("click", () => table.getColumns().forEach(col => col.show()));
    });
  </script>
</body>
</html>
